name: MGF Sync — Voice Intelligence

on:
  push:
    branches: [main]
    paths:
      - "labs/**/mgf-metadata.json"
      - ".github/workflows/mgf-sync.yml"
  workflow_dispatch:

jobs:
  mgf-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Validate mgf-metadata.json files
        run: |
          python << 'EOF'
          import json
          from pathlib import Path
          import sys

          required = {
              "mgf_version",
              "artifact_type",
              "artifact_id",
              "title",
              "domain",
              "category",
              "authoritative_source",
              "status"
          }

          errors = 0

          for path in Path("labs").rglob("mgf-metadata.json"):
              try:
                  data = json.loads(path.read_text())
                  missing = required - data.keys()
                  if missing:
                      print(f"❌ {path} missing keys: {missing}")
                      errors += 1
                  else:
                      print(f"✅ {path}")
              except Exception as e:
                  print(f"❌ {path} invalid JSON: {e}")
                  errors += 1

          if errors:
              sys.exit(1)
          EOF

      - name: Generate mgf-sync.lab.json
        run: |
          python << 'EOF'
          import json
          from pathlib import Path

          labs = []

          for path in Path("labs").rglob("mgf-metadata.json"):
              data = json.loads(path.read_text())
              data["_path"] = str(path.parent)
              labs.append(data)

          out = {
              "source": "stc-voice-intelligence",
              "authority": "MGF-AUTHORITY-ALL",
              "artifact_type": "lab",
              "count": len(labs),
              "artifacts": labs
          }

          Path("mgf-sync.lab.json").write_text(json.dumps(out, indent=2))
          print(f"✅ Generated mgf-sync.lab.json with {len(labs)} labs")
          EOF

      - name: Upload MGF sync artifact
        uses: actions/upload-artifact@v4
        with:
          name: mgf-sync-labs
          path: mgf-sync.lab.json
